<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">

    <link rel="stylesheet" href="./index.css">
</head>
<body>
<script id="setting" type="text/html">
    <form class="layui-form" action="" lay-filter="setting">
        <fieldset class="layui-elem-field layui-field-title" style="">
            <legend>玩家配置</legend>
        </fieldset>
        <div class="layui-form-item">
            <label class="layui-form-label" style="width: auto">显示玩家装备</label>
            <div class="layui-input-block">
                <input type="checkbox" name="filter_show_player_backpack" lay-skin="switch" lay-text="ON|OFF">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="width: auto">危险区遭遇时在坐骑上显示绿色</label>
            <div class="layui-input-block">
                <input type="checkbox" name="filter_show_player_in_danger_show_green" lay-skin="switch"
                       lay-text="ON|OFF">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="width: auto">红黑区遇敌提示音</label>
            <div class="layui-input-block">
                <input type="checkbox" name="tip_for_player_sound" lay-skin="switch" lay-text="ON|OFF">
            </div>
        </div>
        <fieldset class="layui-elem-field layui-field-title" style="">
            <legend>友方单位配置</legend>
        </fieldset>
        <div class="layui-form-item">
            <label class="layui-form-label" style="width: auto">屏蔽队友/盟友</label>
            <div class="layui-input-block">
                <input type="checkbox" name="filter_green_friend" lay-skin="switch" lay-text="ON|OFF">
            </div>
        </div>
        <fieldset class="layui-elem-field layui-field-title" style="">
            <legend>洞穴配置</legend>
        </fieldset>
        <div class="layui-row">
            <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                <label class="layui-form-label" style="width: auto">显示普通洞穴</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="filter_show_dungeon_normal" lay-skin="switch" lay-text="ON|OFF">
                </div>
            </div>
            <div class="layui-col-xs6 layui-col-sm6 layui-col-md6">
                <label class="layui-form-label" style="width: auto">显示稀有洞穴</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="filter_show_dungeon_quality" lay-skin="switch" lay-text="ON|OFF">
                </div>
            </div>
        </div>

        <fieldset class="layui-elem-field layui-field-title" style="">
            <legend>怪物配置</legend>
        </fieldset>
        <div class="layui-form-item">
            <label class="layui-form-label" style="width: auto">显示普通怪物</label>
            <div class="layui-input-block">
                <input type="checkbox" name="filter_show_monster_normal" lay-skin="switch" lay-text="ON|OFF">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="width: auto">显示资源怪物</label>
            <div class="layui-input-block">
                <input type="checkbox" name="filter_show_mobs_icon_for_item" lay-skin="switch" lay-text="ON|OFF">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="width: auto">显示稀有怪物(附魔品质>1)</label>
            <div class="layui-input-block">
                <input type="checkbox" name="filter_show_monster_quality" lay-skin="switch" lay-text="ON|OFF">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="width: auto">关闭怪物名称显示</label>
            <div class="layui-input-block">
                <input type="checkbox" name="filter_show_no_mobs_name" lay-skin="switch" lay-text="ON|OFF">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="width: auto">显示迷雾精灵</label>
            <div class="layui-input-block">
                <input type="checkbox" name="filter_show_monster_mist" lay-skin="switch" lay-text="ON|OFF">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="width: auto">显示灯笼怪</label>
            <div class="layui-input-block">
                <input type="checkbox" name="filter_show_cage_mist" lay-skin="switch" lay-text="ON|OFF">
            </div>
        </div>
        <fieldset class="layui-elem-field layui-field-title" style="">
            <legend>物资配置</legend>
        </fieldset>
        <div class="layui-form-item">
            <label class="layui-form-label">物资类型</label>
            <div class="layui-input-block">
                <input type="checkbox" name="filter_item_rock" title="石头">
                <input type="checkbox" name="filter_item_ore" title="矿物">
                <input type="checkbox" name="filter_item_wood" title="树木">
                <input type="checkbox" name="filter_item_fiber" title="棉花">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">物资等级</label>
            <div class="layui-input-inline">
                <select name="filter_item_level">
                    <option value="0">全部</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                </select>
            </div>
            <div class="layui-input-inline">
                <select name="filter_item_quality">
                    <option value="0">全部</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>

                    <option value="4">4</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label" style="width: auto">显示数量在0以上的资源</label>
            <div class="layui-input-block">
                <input type="checkbox" name="filter_item_show_zero_count" lay-skin="switch" lay-text="ON|OFF">
            </div>
        </div>
        <div class="layui-form-item">
            &nbsp;
        </div>
    </form>
</script>
<script>
    fetch('https://oss.tisoz.com/version.txt')
        .then(response => response.json())
        .then(data => console.log(data))
        .catch(error => console.error(error))

    const raw_json_deault = {
        "filter_show_player_backpack": "off",
        "filter_item_rock": "off",
        "filter_item_ore": "off",
        "filter_item_wood": "off",
        "filter_item_fiber": "off",
        "filter_item_level": "0",
        "filter_item_quality": "0",
        "filter_show_monster_normal": "off",
        "filter_show_monster_quality": "off",
        "filter_show_monster_mist": "off",
        "filter_show_dungeon_normal": "off",
        "filter_show_dungeon_quality": "off",
        "filter_show_player_in_danger_show_green": "off",
        "filter_item_show_zero_count": "off",
        "filter_show_mobs_icon_for_item": "off",
        "tip_for_player_sound": "off",
        "filter_show_no_mobs_name": "off",
        "filter_show_cage_mist": "off",
        "filter_green_friend": "off"
    }

    // 配置文件
    setInterval(() => {
        let raw_config_default = JSON.stringify(raw_json_deault, function (key, value) {
            if (value === "on") {
                return true;
            } else if (value === "off") {
                return false;
            } else {
                return value;
            }
        });
        let save_config = JSON.stringify(Object.assign(JSON.parse(raw_config_default), layui.form.val()), function (key, value) {
            if (value === "on") {
                return true;
            } else if (value === "off") {
                return false;
            } else {
                return value;
            }
        });
        localStorage.setItem("config", save_config)
    }, 3000)


    window.onload = () => {
        window.addEventListener('keydown', (event) => {
            // 如果按下 F5
            if (event.key === 'F5') {
                // 向主进程发送 refresh 事件
                location.reload()
            }
        });

        let raw_config_default = JSON.stringify(raw_json_deault, function (key, value) {
            if (value === "on") {
                return true;
            } else if (value === "off") {
                return false;
            } else {
                return value;
            }
        });

        let page_radar = document.createElement("div");
        page_radar.setAttribute("style", "width:100%;height:100%;position:absolute;")
        page_radar.id = "radar_page"
        body_container.appendChild(page_radar)

        let page_spider = document.createElement("div")
        page_spider.setAttribute("style", "width:100%;height:100%;position:absolute;display:none;overflow:scroll")
        page_spider.id = "radar_setting_page"
        page_spider.innerHTML = document.getElementById("setting").innerHTML
        body_container.appendChild(page_spider)
        layui.form.render()
        layui.form.val("setting", Object.assign(JSON.parse(raw_config_default), JSON.parse(localStorage.getItem("config"))))

        let app = new PIXI.Application({
            width: 400, height: 300, backgroundAlpha: 0,

        });
        app.renderer.background.alpha = 0;
        // app.stage.alpha = 0
        // var renderer = PIXI.autoDetectRenderer(256, 256, {antialias: false, transparent: true, resolution: 1});
        // renderer.render(app.stage)

        global.container = new PIXI.Container();
        container.rotation = -(Math.PI / 4 * 3)
        global.backpack_container = new PIXI.Container();
        // container.scale.x = -1
        // let graphics = new PIXI.Graphics();
        // graphics.lineStyle(2, 0x666666, 1); // 设置线条样式（宽度、颜色、透明度）
        // graphics.drawRect(0, 0, 100, 100); // 绘制矩形（x, y, width, height）
        // container.addChild(graphics);


        app.stage.addChild(backpack_container)
        app.stage.addChild(container)
        app.stage.scale.x = 5
        app.stage.scale.y = 5

        let center = PIXI.Sprite.from('center.png');
        center.scale.x = 1 / app.stage.scale.x
        center.scale.y = 1 / app.stage.scale.y
        center.anchor.set(0.5)
        container.addChild(center)

        page_radar.appendChild(app.view);

        // 滚轮缩小
        window.addEventListener("mousewheel", (event) => {
            const step = event.wheelDelta > 0 ? 0.1 : -0.1
            if (app.stage.scale.x + step >= 0.1) {
                app.stage.scale.x += step
                app.stage.scale.y += step
                center.scale.x = 1 / app.stage.scale.x
                center.scale.y = 1 / app.stage.scale.y
            }
        })
        // PIXI.Ticker.targetFPMS = 1;
        app.ticker.minFPS = 30;
        app.ticker.maxFPS = 60;


        // 添加地图信息
        let temp_world_text = new PIXI.Text(`当前地图:${current_map['@displayname']}`, {
            align: "right",
            fontFamily: 'JetBrainsMono-Bold',
            fontSize: 14,
            fill: "white",

        });
        temp_world_text.anchor.set(1, 0);
        temp_world_text.name = "map_info"
        app.stage.addChild(temp_world_text)

        app.ticker.add((delta) => {
            if (global['transparent']) {
                app.renderer.background.alpha = 0;
            } else {
                app.renderer.background.alpha = 1;
            }
            globalThis.config = JSON.parse(localStorage.getItem("config"));
            let temp_world_text = app.stage.getChildByName("map_info");
            temp_world_text.text = `当前地图:${current_map['@displayname']}\n当前速度:${local_player_position['speed']}`
            let text_color = "white";
            if (['YELLOW', 'RED'].indexOf(current_map['@rareresourcedistribution']) + 1) text_color = current_map['@rareresourcedistribution']
            temp_world_text.style.fill = text_color;
            temp_world_text.name = "map_info"
            temp_world_text.scale.x = 1 / app.stage.scale.x
            temp_world_text.scale.y = 1 / app.stage.scale.y
            temp_world_text.position.set(app.screen.width / app.stage.scale.x, 0);

            //修改画板大小
            app.renderer.resize(body_container.getClientRects()[0].width - 40, body_container.getClientRects()[0].height - 60 - 20)


            // center.position.set()
            if (global.clear_data) {
                let center = container.children[0];
                container.removeChildren()
                backpack_container.removeChildren()
                container.addChild(center)
                player_list = {}
                monster_list = {}
                item_list = {}
                global.clear_data = false;
            }

            // container.sortChildren()
            //加载玩家信息
            try {
                let player_count = 0;
                for (let index in player_list) {
                    player_count += 1;
                    item = player_list[index]
                    if (config['filter_green_friend'] && globalThis.white_player_list.indexOf(item['name']) + 1) {
                        if (item['in_container']) {
                            container.removeChild(container.getChildByName(item['id'].toString()))
                            backpack_container.removeChild(backpack_container.getChildByName(item['id'].toString()))
                            item['in_container'] = false
                        }
                        continue
                    }
                    if (item['in_container']) {
                        let temp_img = container.getChildByName(item['in_container_index']);
                        if (temp_img == null || item == null) continue
                        if (item['hp_max'] && !item['hp']) {
                            item['hp'] = 0
                            item['uni_id'] = "player_dead.png"
                        }
                        temp_img.texture = PIXI.Texture.from('./resource/' + item['uni_id']);
                        if (config['filter_show_player_backpack']) {
                            let temp_back = backpack_container.getChildByName(item['in_container_index']);
                            if (temp_back != null) {
                                temp_back.scale.x = 1 / app.stage.scale.x / 2
                                temp_back.scale.y = 1 / app.stage.scale.y / 2
                                temp_back.y = (player_count - 1) * 70 / app.stage.scale.y
                            }
                        }
                        // 计算物资位置与玩家位置
                        let x = item['position'][0] - globalThis['local_player_position']['current_postion'][0];
                        let y = item['position'][1] - globalThis['local_player_position']['current_postion'][1];

                        let state_text = item['mounted'] ? "骑乘" : "下马";
                        let distance = Math.sqrt(x * x + y * y).toFixed(2)
                        if (distance > 80) {
                            if (globalThis['local_player_position']['current_postion'][0] !== 0) {
                                if (globalThis.white_player_list.indexOf(item['name']) === -1 && item['name'] !== "PA") {
                                    // globalThis.white_player_list.push(item['name'])
                                }
                            }
                        }
                        // 更新文本数据
                        temp_img.getChildAt(0).text = `${item['name']}[${distance}m]\n[${state_text}][hp:${item['hp']}/${item['hp_max']}]`

                        TweenMax.to(temp_img.position, 0.2, {x: -item['position'][0], y: item['position'][1]});
                        temp_img.scale.x = 1 / app.stage.scale.x
                        temp_img.scale.y = 1 / app.stage.scale.y
                    } else {
                        if (!item['position']) continue
                        if ((item['club'] !== "" && globalThis['club'] === item['club']) || (item['union'] !== "" && globalThis['union'] === item['union'])) {
                            if (globalThis.white_player_list.indexOf(item['name']) === -1) {
                                globalThis.white_player_list.push(item['name'])
                            }
                        }
                        if (config['tip_for_player_sound'] && globalThis.white_player_list.indexOf(item['name']) === -1) {
                            if (current_map['@rareresourcedistribution'] !== "DEFAULT" && ((item['uni_id'].indexOf("red") + 1)
                                || (current_map['@rareresourcedistribution'].indexOf("RED") + 1)
                                || (current_map['@rareresourcedistribution'].indexOf("OUT") + 1)
                                || (current_map['@type'].indexOf("BLACK") + 1)
                                || (current_map['@type'].indexOf("RED") + 1))) {
                                let temp_audio = new Audio("./resource/tip.mp3");
                                new Promise((resolve, reject) => {
                                    temp_audio.play()
                                })
                            }
                        }


                        let temp_img = PIXI.Sprite.from('./resource/' + item['uni_id']);
                        temp_img.x = -item['position'][0];
                        temp_img.y = item['position'][1];
                        temp_img.scale.x = 1 / app.stage.scale.x
                        temp_img.scale.y = 1 / app.stage.scale.y
                        temp_img.anchor.set(0.5)
                        temp_img.rotation = (Math.PI / 4 * 3)
                        temp_img.name = item['id'].toString();
                        // temp_img.zIndex = item['quality']
                        // 创建数量文本
                        let fill = "white";
                        if (globalThis.white_player_list.indexOf(item['name']) + 1) {
                            fill = "green"
                        }
                        let temp_text = new PIXI.Text(`${item['hp']}/${item['hp_max']}`, {
                            align: "center",
                            fontFamily: 'JetBrainsMono-Bold',
                            fontSize: 14,
                            fill: fill,
                        });
                        temp_text.anchor.set(0.5);
                        // temp_text.x = ;
                        temp_text.y = 25;
                        temp_img.addChild(temp_text)
                        container.addChild(temp_img)
                        item['in_container_index'] = temp_img.name
                        item['in_container'] = true
                        player_list[index] = item


                        // 玩家装备显示
                        // 创建容器
                        if (config['filter_show_player_backpack']) {
                            let backpack = new PIXI.Container();
                            backpack.name = item['id'].toString();
                            backpack.scale.x = 1 / app.stage.scale.x / 2
                            backpack.scale.y = 1 / app.stage.scale.y / 2
                            backpack.y = (backpack_container.children.length) * 70 / app.stage.scale.y

                            let powersum = 0
                            for (let i in item['backpack']) {
                                let index = item['backpack'][i];
                                if (index === 0) continue;
                                let model = PIXI.Sprite.from('./resource/' + item_list_json[index]['unique'])
                                if (item_info_json[item_list_json[index]['unique']] === undefined) {
                                    console.log(item_list_json[index]['unique'])
                                }
                                let itempower = item_info_json[item_list_json[index]['unique']];
                                if (item_list_json[index]['unique'] === "UNIQUE_HIDEOUT") continue
                                if (itempower['itempower']) {
                                    itempower = itempower['itempower']
                                } else {
                                    continue
                                }
                                powersum += parseInt(itempower)
                                model.x = i * 100
                                model.y = 34
                                backpack.addChild(model);
                            }

                            temp_text = new PIXI.Text(`${item['name']}(${item['hp']}/${item['hp_max']})(强度:${parseInt(powersum / 6)})`, {
                                fontFamily: 'JetBrainsMono-Bold',
                                fontSize: 34,
                                fill: 'white',
                            });
                            backpack.addChild(temp_text)
                            backpack_container.addChild(backpack);
                        }
                    }
                }

                // 加载宝箱信息
                for (let index in chest_list) {
                    item = chest_list[index]
                    if (item['in_container']) {
                        let temp_img = container.getChildByName(item['in_container_index']);
                        if (temp_img == null || item == null) continue

                        temp_img.scale.x = 1 / app.stage.scale.x / 2
                        temp_img.scale.y = 1 / app.stage.scale.y / 2
                    } else {
                        if (!item['position']) continue

                        let temp_img = PIXI.Sprite.from('./resource/' + item['uni_id']);
                        temp_img.x = -item['position'][0];
                        temp_img.y = item['position'][1];
                        temp_img.scale.x = 1 / app.stage.scale.x / 2
                        temp_img.scale.y = 1 / app.stage.scale.y / 2
                        temp_img.anchor.set(0.5)
                        temp_img.rotation = (Math.PI / 4 * 3)
                        temp_img.name = item['id'].toString();
                        // temp_img.zIndex = item['quality']
                        // 创建数量文本
                        let temp_text = new PIXI.Text(`${item['name']}`, {
                            fontFamily: 'JetBrainsMono-Bold',
                            fontSize: 14,
                            fill: check_quality(item['quality']),
                        });
                        temp_text.anchor.set(0.5);
                        temp_text.scale.x = 2
                        temp_text.scale.y = 2
                        // temp_text.x = ;
                        temp_text.y = 70;
                        temp_img.addChild(temp_text)
                        container.addChild(temp_img)
                        item['in_container_index'] = temp_img.name
                        item['in_container'] = true
                        chest_list[index] = item
                    }
                }

                // 性能优化
                if (globalThis['local_player_position']['changed_position']) return
                globalThis['local_player_position']['changed_position'] = true;

                let x_flag = 1;
                if (globalThis['local_player_position']['current_postion'][0] < 0) x_flag = -1;
                TweenMax.to(container.position, 0.2, {
                    x: app.screen.width / 2 / app.stage.scale.x - globalThis['local_player_center_postion'][0] - Math.sqrt(Math.pow(2 * globalThis['local_player_position']['current_postion'][0], 2) / 2) * x_flag,
                    y: app.screen.height / 2 / app.stage.scale.y + globalThis['local_player_center_postion'][1] - Math.sqrt(Math.pow(2 * globalThis['local_player_position']['current_postion'][0], 2) / 2) * x_flag
                });
                TweenMax.to(center.position, 0.2, {
                    x: -globalThis['local_player_position']['current_postion'][0],
                    y: globalThis['local_player_position']['current_postion'][1]
                });
                //动态加入物资信息
                for (let index in item_list) {
                    item = item_list[index]
                    if (item['level'] < config['filter_item_level']) {
                        if (item['in_container']) container.removeChild(container.getChildByName(item['id'].toString()))
                        continue
                    }
                    if (item['quality'] < config['filter_item_quality']) {
                        if (item['in_container']) container.removeChild(container.getChildByName(item['id'].toString()))
                        continue
                    }
                    if (!config['filter_item_ore'] && item['type'] === 23) {
                        if (item['in_container']) container.removeChild(container.getChildByName(item['id'].toString()))
                        continue
                    }
                    if (!config['filter_item_wood'] && item['type'] === 0) {
                        if (item['in_container']) container.removeChild(container.getChildByName(item['id'].toString()))
                        continue
                    }
                    if (!config['filter_item_rock'] && item['type'] === 6) {
                        if (item['in_container']) container.removeChild(container.getChildByName(item['id'].toString()))
                        continue
                    }
                    if (!config['filter_item_fiber'] && item['type'] === 12) {
                        if (item['in_container']) container.removeChild(container.getChildByName(item['id'].toString()))
                        continue
                    }
                    if (config['filter_item_show_zero_count'] && item['count'] === 0) {
                        if (item['in_container']) container.removeChild(container.getChildByName(item['id'].toString()))
                        continue
                    }
                    if (item['in_container']) {
                        let temp_img = container.getChildByName(item['id'].toString());
                        if (temp_img == null || item == null) continue

                        // 创建一个新纹理
                        // 将精灵的纹理设置为新纹理
                        temp_img.texture = PIXI.Texture.from('./resource/' + item['uni_id']);

                        // 更新物资数量
                        temp_img.getChildAt(0).text = item['count'] || 0;

                        // 计算物资位置与玩家位置 , 当玩家位置更新后 , 分五次进行物资位置更新
                        temp_img.scale.x = 1 / app.stage.scale.x / 2
                        temp_img.scale.y = 1 / app.stage.scale.y / 2
                    } else {
                        if (!item['position']) continue

                        let temp_img = PIXI.Sprite.from('./resource/' + item['uni_id']);
                        temp_img.x = -(item['position'][0]);
                        temp_img.y = (item['position'][1]);
                        temp_img.scale.x = 1 / app.stage.scale.x / 2
                        temp_img.scale.y = 1 / app.stage.scale.y / 2
                        temp_img.anchor.set(0.5)
                        temp_img.rotation = (Math.PI / 4 * 3)
                        temp_img.name = item['id'].toString();
                        temp_img.zIndex = item['quality']

                        // 创建数量文本
                        let temp_text = new PIXI.Text(item['count'].toString(), {
                            fontFamily: 'JetBrainsMono-Bold',
                            fontSize: 26,
                            fill: "white",
                        });
                        temp_text.anchor.set(0.5);
                        temp_text.x = 27;
                        temp_text.y = 24;
                        temp_img.addChild(temp_text)
                        container.addChild(temp_img)
                        item['in_container_index'] = temp_img.name
                        item['in_container'] = true
                        item_list[index] = item
                    }
                }

                //加载怪物信息
                for (let index in monster_list) {
                    item = monster_list[index]
                    if (!config['filter_show_monster_normal']) {
                        if (item['quality'] < 1 && item['type'] > 10 && !item['resource']) {
                            container.removeChild(container.getChildByName(item['id'].toString()))
                            continue
                        }
                    }
                    if (!config['filter_show_monster_quality']) {
                        if (item['quality'] >= 1 && item['type'] > 10) {
                            container.removeChild(container.getChildByName(item['id'].toString()))
                            continue
                        }
                    }
                    if (!config['filter_show_monster_mist']) {
                        if (item['type'] < 10) {
                            container.removeChild(container.getChildByName(item['id'].toString()))
                            continue
                        }
                    }
                    if (config['filter_show_no_mobs_name']) {
                        item['name'] = ""
                    }
                    if (!config['filter_show_mobs_icon_for_item']) {
                        if (item['resource']) {
                            container.removeChild(container.getChildByName(item['id'].toString()))
                            continue
                        }
                    }
                    if (item['in_container']) {
                        let temp_img = container.getChildByName(item['in_container_index']);
                        if (temp_img == null || item == null) continue

                        // 更新文本数据
                        if (item['resource']) {
                            temp_img.getChildAt(0).text = `${item['name']}[hp:${item['hp']}][L${item['quality']}][${item['resource']}]`
                        } else {
                            temp_img.getChildAt(0).text = `${item['name']}[hp:${item['hp']}][L${item['quality']}]`
                        }
                        TweenMax.to(temp_img.position, 0.2, {x: -item['position'][0], y: item['position'][1]});
                        // 计算物资位置与玩家位置
                        temp_img.scale.x = 1 / app.stage.scale.x / 2
                        temp_img.scale.y = 1 / app.stage.scale.y / 2
                    } else {
                        if (!item['position']) continue
                        if (item['res_id']) item['uni_id'] = item['res_id']
                        let temp_img = PIXI.Sprite.from('./resource/' + item['uni_id']);
                        temp_img.x = -(item['position'][0]);
                        temp_img.y = (item['position'][1]);
                        temp_img.scale.x = 1 / app.stage.scale.x / 2
                        temp_img.scale.y = 1 / app.stage.scale.y / 2
                        temp_img.anchor.set(0.5)
                        temp_img.rotation = (Math.PI / 4 * 3)
                        temp_img.name = item['id'].toString();
                        // temp_img.zIndex = item['quality']
                        // 创建数量文本
                        let temp_text = new PIXI.Text(`${item['hp']}/${item['hp_max']}[L${item['quality']}]`, {
                            fontFamily: 'JetBrainsMono-Bold',
                            fontSize: 14,
                            fill: check_quality(item['quality']),
                        });
                        temp_text.anchor.set(0.5);
                        temp_text.scale.x = 2
                        temp_text.scale.y = 2
                        // temp_text.x = ;
                        temp_text.y = 50;
                        temp_img.addChild(temp_text)
                        container.addChild(temp_img)
                        item['in_container_index'] = temp_img.name
                        item['in_container'] = true
                        monster_list[index] = item
                    }
                }

                // 加载洞穴信息
                for (let index in dungeon_list) {
                    item = dungeon_list[index]
                    if (!config['filter_show_dungeon_normal']) {
                        if (item['quality'] < 1) {
                            container.removeChild(container.getChildByName(item['id'].toString()))
                            continue
                        }
                    }
                    if (!config['filter_show_dungeon_quality']) {
                        if (item['quality'] >= 1) {
                            container.removeChild(container.getChildByName(item['id'].toString()))
                            continue
                        }
                    }
                    if (item['in_container']) {
                        let temp_img = container.getChildByName(item['in_container_index']);
                        if (temp_img == null || item == null) continue
                        // 计算物资位置与玩家位置
                        temp_img.scale.x = 1 / app.stage.scale.x / 2
                        temp_img.scale.y = 1 / app.stage.scale.y / 2
                    } else {
                        if (!item['position']) continue

                        let temp_img = PIXI.Sprite.from('./resource/' + item['uni_id']);
                        temp_img.x = -item['position'][0];
                        temp_img.y = item['position'][1];
                        temp_img.scale.x = 1 / app.stage.scale.x / 2
                        temp_img.scale.y = 1 / app.stage.scale.y / 2
                        temp_img.anchor.set(0.5)
                        temp_img.rotation = (Math.PI / 4 * 3)
                        temp_img.name = item['id'].toString();
                        // temp_img.zIndex = item['quality']
                        // 创建数量文本
                        let temp_text = new PIXI.Text(`${item['name']}[L${item['quality']}]`, {
                            fontFamily: 'JetBrainsMono-Bold',
                            fontSize: 14,
                            fill: check_quality(item['quality']),
                        });
                        temp_text.anchor.set(0.5);
                        temp_text.scale.x = 2
                        temp_text.scale.y = 2
                        // temp_text.x = ;
                        temp_text.y = 70;
                        temp_img.addChild(temp_text)
                        container.addChild(temp_img)
                        item['in_container_index'] = temp_img.name
                        item['in_container'] = true
                        dungeon_list[index] = item
                    }
                }

                // 加载临时信息
                for (let index in temp_list) {
                    item = temp_list[index]
                    if (!config['filter_show_cage_mist']) {
                        if (item['uni_id'] === "heretic.png") {
                            container.removeChild(container.getChildByName(item['id'].toString()))
                            continue
                        }
                    }
                    if (item['in_container']) {
                        let temp_img = container.getChildByName(item['in_container_index']);
                        if (temp_img == null || item == null) continue


                        // 计算物资位置与玩家位置
                        let x = item['position'][0];
                        let y = item['position'][1];

                        TweenMax.to(temp_img.position, 0.2, {x: -x, y: y});
                        temp_img.scale.x = 1 / app.stage.scale.x / 4
                        temp_img.scale.y = 1 / app.stage.scale.y / 4
                    } else {
                        if (!item['position']) continue

                        let temp_img = PIXI.Sprite.from('./resource/' + item['uni_id']);
                        temp_img.x = -item['position'][0];
                        temp_img.y = item['position'][1];
                        temp_img.scale.x = 1 / app.stage.scale.x / 4
                        temp_img.scale.y = 1 / app.stage.scale.y / 4
                        temp_img.anchor.set(0.5)
                        temp_img.rotation = (Math.PI / 4 * 3)
                        temp_img.name = item['id'].toString();
                        // temp_img.zIndex = item['quality']
                        // 创建数量文本
                        let temp_text = new PIXI.Text(`${item['name']}`, {
                            fontFamily: 'JetBrainsMono-Bold',
                            fontSize: 14,
                            fill: check_quality(item['quality']),
                        });
                        temp_text.anchor.set(0.5);
                        temp_text.scale.x = 4
                        temp_text.scale.y = 4
                        // temp_text.x = ;
                        temp_text.y = 70;
                        temp_img.addChild(temp_text)
                        container.addChild(temp_img)
                        item['in_container_index'] = temp_img.name
                        item['in_container'] = true
                        temp_list[index] = item
                    }
                }

            } catch (e) {
                console.log(e)
                if (new Date().getTime() - globalThis.update_time < 60000) return

                let formData = new FormData();
                formData.append('type', 1);
                formData.append('text', e.stack);
                globalThis.update_time = new Date().getTime()
                fetch('http://8.218.34.95/api/log', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        "token": localStorage.getItem('token')
                    }
                })
            }


        });
        app.stage.interactive = true;
        app.stage.hitArea = app.screen;
        app.stage.on('pointerup', onDragEnd);
        app.stage.on('pointerupoutside', onDragEnd);
        app.stage.on('pointerdown', onDragStart, container);
        let dragTarget = null;
        let old_event = {}
        let old_position = {}

        function check_quality(quality) {
            switch (quality) {
                case 0 :
                    return "white";
                case 1:
                    return "green";
                case 2:
                    return "blue";
                case 3:
                    return "purple";
                case 4:
                    return "orange";
                default:
                    return "white";
            }
        }

        function onDragMove(event) {
            if (dragTarget) {
                dragTarget.x = old_position.x + (event.client.x - old_event.x) / app.stage.scale.x;
                dragTarget.y = old_position.y + (event.client.y - old_event.y) / app.stage.scale.y;
            }
        }

        function onDragStart(event) {
            old_event = {x: event.clientX, y: event.clientY};
            old_position = {x: this.x, y: this.y}
            this.alpha = 0.5;
            dragTarget = this;
            app.stage.on('pointermove', onDragMove);
        }

        global.radar_move ||= 0;

        function onDragEnd() {
            if (dragTarget) {
                global.radar_move = new Date().getTime()
                app.stage.off('pointermove', onDragMove);
                dragTarget.alpha = 1;
                dragTarget = null;
            }
        }

        let tool_bar = document.getElementById('tool_bar')
        let window_position = []
        document.addEventListener('mousedown', (event) => {
            if (event.button === 0) {
                window_position = {x: event.screenX, y: event.screenY}
                document.body.style.cursor = "move";
            }
        })
        document.addEventListener('mouseup', (event) => {
            if (event.button === 0) {
                window_position.x = event.screenX - window_position.x
                window_position.y = event.screenY - window_position.y
                document.body.style.cursor = "auto";
                if (new Date().getTime() - global.radar_move > 10) ipcRenderer.send('window-drag', window_position)
            }
        })
        // 格三秒刷新资源
        setInterval(() => {
            globalThis['local_player_position']['changed_position'] = false;
        }, 3000);

    }


</script>
<script src="./tool_bar.js"></script>
<script src="./pixi.min.js"></script>
<script src="./TweenMax.min.js"></script>
<script src="./pcap_deal.js"></script>
</body>
</html>